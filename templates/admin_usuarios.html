{% extends "base_admin.html" %}

{% block title %}Gesti√≥n de Usuarios - Sistema EEC{% endblock %}

{% block extra_css %}
<style>
    .card-header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .btn-create {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        transition: all 0.3s ease;
    }
    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }
    .btn-delete {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
        border: none;
        transition: all 0.3s ease;
    }
    .btn-delete:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
    }
    .user-badge {
        font-size: 0.75rem;
    }
    .stats-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 15px;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .table-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    .table-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .action-buttons .btn {
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .action-buttons .btn:hover {
        transform: translateY(-2px);
    }
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 10px;
    }
    .system-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-admin">
    <!-- Header de la P√°gina -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5 fw-bold text-primary mb-3">
            <i class="bi bi-people-fill me-3"></i>Gesti√≥n de Usuarios
        </h1>
    </div>

    <!-- Panel Principal de Gesti√≥n -->
    <div class="row">
        <div class="col-12">
            <div class="card table-card">
                <div class="card-header card-header-gradient py-3">
                    <h4 class="card-title mb-0 text-white">
                        <i class="bi bi-shield-check me-2 text-white"></i>Panel de Administraci√≥n de Usuarios
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- Botones de Acci√≥n Masiva -->
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-3">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <button class="btn btn-create btn-lg w-100 py-3" onclick="generarTodosUsuarios()">
                                        <i class="bi bi-person-plus-fill me-2"></i> 
                                        Generar Usuarios Autom√°ticamente
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        Crea usuarios autom√°ticamente para todas las {{ matriculas_sin_usuario|length }} matr√≠culas sin usuario asignado
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('pase_lista') }}" class="btn btn-primary btn-lg py-3">
                                            <i class="bi bi-clipboard-check me-2"></i> 
                                            Ver Listas de Asistencia
                                        </a>
                                        <small class="text-muted d-block mt-2">
                                            Gestionar las {{ total_listas_sistema }} listas de asistencia del sistema
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert para mensajes -->
                    <div id="alertContainer"></div>

                    <div class="row">
                        <!-- Matr√≠culas sin usuario -->
                        <div class="col-lg-6 mb-4">
                            <div class="card table-card h-100">
                                <div class="card-header bg-warning text-white py-3">
                                    <h5 class="card-title mb-0 text-white">
                                        <i class="bi bi-exclamation-triangle-fill text-white me-2"></i> 
                                        Matr√≠culas sin Usuario
                                        <span class="badge bg-dark ms-2">{{ matriculas_sin_usuario|length }}</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if matriculas_sin_usuario %}
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm align-middle">
                                            <thead class="table-warning">
                                                <tr>
                                                    <th>Alumno</th>
                                                    <th>C√≥digo</th>
                                                    <th>Grupo</th>
                                                    <th>Acci√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for matricula in matriculas_sin_usuario %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar">
                                                                {{ matricula.alumno_nombre[0] if matricula.alumno_nombre else '?' }}
                                                            </div>
                                                            <div>
                                                                <strong>{{ matricula.alumno_nombre }} {{ matricula.alumno_apellido }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    ID: {{ matricula.id }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {% if matricula.codigo_matricula %}
                                                        <code class="bg-light p-1 rounded">{{ matricula.codigo_matricula }}</code>
                                                        {% else %}
                                                        <span class="badge bg-secondary">Sin c√≥digo</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if matricula.grupo_nombre %}
                                                        <span class="badge bg-info">{{ matricula.grupo_nombre }}</span>
                                                        {% else %}
                                                        <span class="badge bg-warning text-dark">Sin grupo</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-success btn-sm" 
                                                                onclick="crearUsuario({{ matricula.id }})"
                                                                {% if not matricula.codigo_matricula %}disabled title="Esta matr√≠cula no tiene c√≥digo generado"{% endif %}>
                                                            <i class="bi bi-person-add me-1"></i> Crear
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <h5>¬°Perfecto!</h5>
                                        <p class="mb-0">Todas las matr√≠culas tienen usuario asignado</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Usuarios existentes -->
                        <div class="col-lg-6 mb-4">
                            <div class="card table-card h-100">
                                <div class="card-header bg-success text-white py-3">
                                    <h5 class="card-title mb-0 text-white">
                                        <i class="bi bi-person-check-fill me-2 text-white"></i> 
                                        Usuarios del Sistema
                                        <span class="badge bg-light text-dark ms-2">{{ usuarios|length }}</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if usuarios %}
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm align-middle">
                                            <thead class="table-success">
                                                <tr>
                                                    <th>Usuario</th>
                                                    <th>Alumno</th>
                                                    <th>Rol</th>
                                                    <th>Acci√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usuario in usuarios %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar {% if usuario.rol == 'admin' %}bg-danger{% else %}bg-info{% endif %}">
                                                                {{ usuario.username[0]|upper }}
                                                            </div>
                                                            <div>
                                                                <code class="fw-bold">{{ usuario.username }}</code>
                                                                <br>
                                                                <small class="text-muted">
                                                                    ID: {{ usuario.id }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {% if usuario.nombre %}
                                                        <strong>{{ usuario.nombre }} {{ usuario.apellido }}</strong>
                                                        <br>
                                                        <small class="text-muted">
                                                            Matr√≠cula ID: {{ usuario.matricula_id or 'N/A' }}
                                                        </small>
                                                        {% else %}
                                                        <span class="text-muted fst-italic">Usuario del sistema</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge {% if usuario.rol == 'admin' %}bg-danger{% else %}bg-primary{% endif %} p-2">
                                                            <i class="bi bi-{% if usuario.rol == 'admin' %}shield-check{% else %}person{% endif %} me-1"></i>
                                                            {{ usuario.rol|title }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% if usuario.rol != 'admin' %}
                                                        <button class="btn btn-delete btn-sm" 
                                                                onclick="eliminarUsuario({{ usuario.id }}, '{{ usuario.username }}')">
                                                            <i class="bi bi-trash me-1"></i> Eliminar
                                                        </button>
                                                        {% else %}
                                                        <span class="text-muted fst-italic">No editable</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <i class="bi bi-people text-muted"></i>
                                        <h5>No hay usuarios</h5>
                                        <p class="mb-0">No se han encontrado usuarios en el sistema</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Sistema -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light border-0">
                                <div class="card-body text-center">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6 class="text-muted mb-1">Total Matr√≠culas</h6>
                                            <h4 class="text-primary">{{ matriculas_con_usuario|length + matriculas_sin_usuario|length }}</h4>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-muted mb-1">Cobertura de Usuarios</h6>
                                            <h4 class="text-success">
                                                {% set total_matriculas = matriculas_con_usuario|length + matriculas_sin_usuario|length %}
                                                {% if total_matriculas > 0 %}
                                                    {{ ((matriculas_con_usuario|length / total_matriculas) * 100)|round(1) }}%
                                                {% else %}
                                                    0%
                                                {% endif %}
                                            </h4>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-muted mb-1">Listas de Asistencia</h6>
                                            <h4 class="text-info">{{ total_listas_sistema }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}-fill me-2"></i>
                <div>${message}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    function crearUsuario(matriculaId) {
        if (!confirm('¬øEst√° seguro de crear un usuario para esta matr√≠cula?\n\nEl nombre de usuario y contrase√±a ser√°n el c√≥digo de matr√≠cula.')) {
            return;
        }

        showAlert('üîÑ Creando usuario, por favor espere...', 'info');

        fetch(`/admin/crear_usuario/${matriculaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                    // Recargar despu√©s de 2 segundos
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(`‚ùå ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`‚ùå Error al crear usuario: ${error}`, 'danger');
            });
    }

    function eliminarUsuario(usuarioId, username) {
        if (!confirm(`¬øEst√° seguro de eliminar el usuario "${username}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
            return;
        }

        showAlert('üîÑ Eliminando usuario, por favor espere...', 'info');

        fetch(`/admin/eliminar_usuario/${usuarioId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                    // Recargar despu√©s de 2 segundos
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(`‚ùå ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`‚ùå Error al eliminar usuario: ${error}`, 'danger');
            });
    }

    function generarTodosUsuarios() {
        const totalSinUsuario = {{ matriculas_sin_usuario|length }};
        
        if (totalSinUsuario === 0) {
            showAlert('‚ÑπÔ∏è No hay matr√≠culas sin usuario para generar.', 'info');
            return;
        }

        if (!confirm(`¬øGenerar usuarios para ${totalSinUsuario} matr√≠culas sin usuario?\n\nEsta operaci√≥n puede tomar unos momentos.`)) {
            return;
        }

        showAlert('üîÑ Generando usuarios autom√°ticamente, por favor espere...', 'info');

        fetch('/admin/generar_todos_usuarios')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                    // Recargar despu√©s de 3 segundos
                    setTimeout(() => location.reload(), 3000);
                } else {
                    showAlert(`‚ùå ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`‚ùå Error al generar usuarios: ${error}`, 'danger');
            });
    }

    // Efectos de hover para las tablas
    document.addEventListener('DOMContentLoaded', function() {
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.style.transition = 'all 0.3s ease';
            row.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
                this.style.backgroundColor = '#f8f9fa';
            });
            row.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.backgroundColor = '';
            });
        });

        // Efectos para las tarjetas de estad√≠sticas
        const statCards = document.querySelectorAll('.stats-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
</script>
{% endblock %}