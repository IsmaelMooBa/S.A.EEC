{% extends "base_estudiante.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-6 fw-bold text-primary mb-2">
                <i class="bi bi-clipboard-data me-2"></i>Detalle de Asistencia
            </h1>
            <p class="text-muted">Informaci√≥n detallada de tu asistencia en esta clase</p>
        </div>
        <a href="{{ url_for('estudiante_asistencia') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-2"></i>Volver a Lista
        </a>
    </div>

    <!-- Informaci√≥n de la Lista -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìã Informaci√≥n de la Clase</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Fecha:</strong> {{ lista.fecha.strftime('%d/%m/%Y') }}
                </div>
                <div class="col-md-2">
                    <strong>Hora:</strong> {{ lista.hora }}
                </div>
                <div class="col-md-3">
                    <strong>Materia:</strong> {{ lista.materia }}
                </div>
                <div class="col-md-2">
                    <strong>Profesor:</strong> {{ lista.profesor }}
                </div>
                <div class="col-md-2">
                    <strong>Grupo:</strong> {{ lista.grupo_nombre }}
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n del Estudiante -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">üë§ Tu Informaci√≥n</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Nombre:</strong> {{ estudiante.alumno.nombre }} {{ estudiante.alumno.apellido }}
                </div>
                <div class="col-md-4">
                    <strong>Matr√≠cula:</strong> {{ estudiante.matricula_actual.codigo_matricula }}
                </div>
                <div class="col-md-4">
                    <strong>Grupo:</strong> {{ estudiante.grupo.nombre }} - {{ estudiante.grupo.grado }}
                </div>
            </div>
        </div>
    </div>

    <!-- Estado de Asistencia -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center h-100 {% if asistencia and asistencia.asistio %}border-success{% else %}border-danger{% endif %}">
                <div class="card-body">
                    <div class="mb-3">
                        {% if asistencia and asistencia.asistio %}
                            <i class="bi bi-check-circle display-4 text-success"></i>
                        {% else %}
                            <i class="bi bi-x-circle display-4 text-danger"></i>
                        {% endif %}
                    </div>
                    <h5 class="card-title">
                        {% if asistencia and asistencia.asistio %}
                            Asisti√≥ a Clase
                        {% else %}
                            No Asisti√≥
                        {% endif %}
                    </h5>
                    <p class="text-muted">
                        {% if asistencia and asistencia.asistio %}
                            Estuviste presente en esta clase seg√∫n el registro del profesor.
                        {% else %}
                            No se registr√≥ tu asistencia en esta clase.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center h-100 border-info">
                <div class="card-body">
                    <div class="mb-3">
                        <i class="bi bi-percent display-4 text-info"></i>
                    </div>
                    <h5 class="card-title">
                        {% if asistencia and asistencia.calificacion is not none %}
                            {{ asistencia.calificacion }}%
                        {% else %}
                            Sin Calificaci√≥n
                        {% endif %}
                    </h5>
                    <p class="text-muted">Calificaci√≥n del examen</p>
                    {% if asistencia and asistencia.calificacion is not none %}
                    <div class="progress mt-2" style="height: 10px;">
                        <div class="progress-bar bg-info" 
                             role="progressbar" 
                             style="width: {{ asistencia.calificacion }}%"
                             aria-valuenow="{{ asistencia.calificacion }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center h-100 {% if asistencia and asistencia.validado %}border-success{% else %}border-warning{% endif %}">
                <div class="card-body">
                    <div class="mb-3">
                        {% if asistencia and asistencia.validado %}
                            <i class="bi bi-shield-check display-4 text-success"></i>
                        {% else %}
                            <i class="bi bi-shield-exclamation display-4 text-warning"></i>
                        {% endif %}
                    </div>
                    <h5 class="card-title">
                        {% if asistencia and asistencia.validado %}
                            Validado
                        {% else %}
                            Pendiente
                        {% endif %}
                    </h5>
                    <p class="text-muted">
                        {% if asistencia and asistencia.validado %}
                            Has confirmado que esta informaci√≥n es correcta.
                        {% else %}
                            A√∫n no has validado esta informaci√≥n.
                        {% endif %}
                    </p>
                    
                    {% if asistencia %}
                        {% if not asistencia.validado %}
                        <button type="button" class="btn btn-success mt-2" onclick="validarAsistencia()">
                            <i class="bi bi-check-circle me-2"></i>Validar Informaci√≥n
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-warning mt-2" onclick="removerValidacion()">
                            <i class="bi bi-x-circle me-2"></i>Remover Validaci√≥n
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">‚ö° Acciones</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>¬øQu√© significa validar?</h6>
                    <p class="small text-muted">
                        Al validar, confirmas que la informaci√≥n de tu asistencia y calificaci√≥n 
                        es correcta seg√∫n tu conocimiento. Esta acci√≥n ayuda a mantener 
                        registros precisos en el sistema.
                    </p>
                </div>
                <div class="col-md-6">
                    <h6>¬øEncontraste un error?</h6>
                    <p class="small text-muted">
                        Si consideras que hay un error en la informaci√≥n registrada, 
                        por favor contacta a tu profesor o al administrador del sistema 
                        para realizar las correcciones necesarias.
                    </p>
                    <button type="button" class="btn btn-outline-danger btn-sm"><a href="https://wa.me/525516966619">
                        <i class="bi bi-exclamation-triangle me-2"></i>Reportar Error 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function validarAsistencia() {
    if (confirm('¬øConfirmas que la informaci√≥n de asistencia y calificaci√≥n es correcta?')) {
        fetch('{{ url_for("estudiante_validar_asistencia") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lista_id: {{ lista.id }},
                validar: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Informaci√≥n validada correctamente');
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    }
}

function removerValidacion() {
    if (confirm('¬øDeseas remover la validaci√≥n de esta informaci√≥n?')) {
        fetch('{{ url_for("estudiante_validar_asistencia") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lista_id: {{ lista.id }},
                validar: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Validaci√≥n removida correctamente');
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    }
}
</script>

<style>
.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.display-4 {
    font-size: 3rem;
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.3s ease;
}

.btn {
    border-radius: 8px;
}
</style>
{% endblock %}